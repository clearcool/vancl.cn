<?phpnamespace App\Http\Controllers\home;use Illuminate\Http\Request;use DB;use App\Http\Requests;use App\Http\Controllers\Controller;use Illuminate\Routing\Route;use Gregwar\Captcha\CaptchaBuilder;use Cache;use Session;class HomeController extends Controller{    /**     * 首页方法     * @param     * @return null     */    public function index()    {        return view('home.index');    }    /**     * 前台登录页面     * @return     */    public function getLogin()    {        return view('home.login');    }    /**     * 手机登录验证码     *     */    public function getCaptcha()    {        //生成验证码图片的Builder对象，配置相应属性        $builder = new CaptchaBuilder;        //可以设置图片宽高及字体        $builder->build($width = 100, $height = 40, $font = null);        //获取验证码的内容        $phrase = $builder->getPhrase();        //把内容存入session        Session::flash('milkcaptcha', $phrase);        //生成图片        header("Cache-Control: no-cache, must-revalidate");        header('Content-Type: image/jpeg');        $builder->output();    }    /**     * 前台登录信息     * @return     */    public function postLoginb()    {        echo '33';    }    /**     * 前台注册页面     * @return     */    public function getRegister()    {        return view('home.register');    }    /**     * 前台注册信息     * @return     */    public function postRegisterb(Request $request)    {        $user = $request->all();        dd($user);    }    /**     * 详情页方法     * @param     * @return     */    public function getDetails(Request $request)    {        $id=$request->input('id');        //分类信息        $type=DB::table('shop_type as t')            ->join('shop_type as t2','t.p_id','=','t2.st_id')            ->join('shop as s','t.st_id','=','s.st_id')            ->select('*','t2.stname as pname','t.stname as tname')            ->where('s.s_id',$id)            ->first();        //商品信息        $shop=DB::table('shop')            ->where('s_id',$id)            ->first();        //详情信息        $pic=DB::table('shop as s')            ->join('shop_detail as sd','s.s_id','=','sd.s_id')            ->select('sd.sd_id','sd.goodsurl','sd.color')            ->get();            $num=0;         for($i=0;$i<=count($pic)-1;$i++)            {                $s=DB::table('shop_stock')                    ->where('sd_id',$pic[$i]->sd_id)                    ->get();                $a=DB::table('shop_stock')                    ->where('sd_id',$pic[$i]->sd_id)                    ->sum('stock');                $stock[$pic[$i]->color]=$s;                $num+=$a;            }        foreach($pic as $k=>$v)        {            $picc[$k]['goodsurl']=explode(';',$v->goodsurl);            $picc[$k]['color']=$v->color;        }//        var_dump($stock);//        dd($shop);        return view('home.details',['type'=>$type,'shop'=>$shop,'num'=>$num,'picc'=>$picc,'stock'=>$stock]);    }    /**     * 详情页图片     * @param color     * @return data     */    public function getPic(Request $request)    {        $color=$request->input('color');        $p=DB::table('shop_detail')            ->where('color',$color)            ->select('goodsurl')            ->first();          $pp=explode(';',$p->goodsurl);          return $pp;    }    /**     * 详情页尺寸     * @param color     * @return data     */    public function getSize(Request $request)    {        $color=$request->input('color');        $size=DB::table('shop_detail as sd')            ->join('shop_stock as st','sd.sd_id','=','st.sd_id')            ->where('sd.color',$color)            ->select('st.ss_id as id','st.size as size','st.stock as stock')            ->get();        return $size;    }    /**     * 头部列表     * @param     * @return     */    public function getHead()    {        return view('home.headlist');    }    /**     * 列表页方法     * @param     * @return     */    public function getList(Request $request)    {        //用户列表页        $id = $request->input('id');        if(!empty("a"))        {            // DB::connection()->enableQueryLog();            $shop = DB::table('shop')                ->where('st_id',$id)                ->paginate(2);            // dd(DB::getQueryLog());        }        switch($request->input('a')){            case "default":                $shop = DB::table('shop')                    ->where('st_id',$id)                    ->paginate(2);                break;            case "sole":                $shop = DB::table('shop')                    ->where('st_id',$id)                    ->orderBy('Sales', 'desc')                    ->paginate(2);                break;            case "praise":                // DB::connection()->enableQueryLog();                $shop = DB::table('shop')                    ->where('st_id',$id)                    ->orderby('praise','desc')                    ->paginate(2);                // dd(DB::getQueryLog());                break;            case "newtime":                $shop = DB::table('shop')                    ->where('st_id',$id)                    ->orderBy('uptime', 'asc')                    ->paginate(2);                break;        }        //商品库存        $shopsales = DB::table('shop')            ->where('st_id',$id)            ->value('Sales');        //类别名查询        $titletype=DB::table('shop_type')            ->where('st_id',$id)            ->value('stname');        //获取所有的请求参数        $all = $request->all();        //解析模板        return view('home.list',['id'=>$id,'shopsales'=>$shopsales,'titletype'=>$titletype,'shop'=>$shop ,'all'=>$all]);    }   }